<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>スマートICTソリューション研究室 教授チャット</title>
<style>
/* ---------------------------------- */
/* 1. 全体レイアウト */
/* ---------------------------------- */
html, body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
  height: 100%;
  margin: 0;
  padding: 0;
  background: #f0f2f5;
}
.container {
  display: flex;
  flex-direction: column;
  height: 100vh;
  max-width: 800px;
  margin: 0 auto;
  background: #ffffff;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

/* ---------------------------------- */
/* 2. ヘッダー */
/* ---------------------------------- */
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 16px;
  border-bottom: 1px solid #ddd;
  background: #f9f9f9;
  flex-shrink: 0;
}
h2 {
  color: #1c1e21;
  font-size: 1.25rem;
  margin: 0;
  padding: 16px 0;
}
.header-controls {
  display: flex;
  align-items: center;
  gap: 10px;
}
.tts-label {
  font-size: 0.9rem;
  cursor: pointer;
  user-select: none;
  display: flex;
  align-items: center;
  gap: 4px;
}
#resetButton {
  background: #e4e6eb;
  color: #050505;
  border: none;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 0.9rem;
  font-weight: bold;
  cursor: pointer;
}
#resetButton:hover {
  background: #d8dbe0;
}

/* ---------------------------------- */
/* 3. チャットログ */
/* ---------------------------------- */
#chat {
  flex-grow: 1;
  overflow-y: auto;
  padding: 20px;
  min-height: 200px;
  display: flex;
  flex-direction: column;
}

.msg-row {
  display: flex;
  align-items: center; 
  margin-bottom: 12px;
  max-width: 90%;
}

/* --- アバター --- */
.avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  justify-content: center;
  align-items: center;
  font-weight: bold;
  font-size: 1.2rem;
  color: white;
  flex-shrink: 0;
  line-height: 1;
  overflow: hidden; 
  padding-bottom: 4px; 
  box-sizing: border-box; 
}
.avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover; 
  padding-bottom: 0; 
}

/* --- 吹き出し --- */
.bubble {
  padding: 12px 16px;
  border-radius: 18px;
  line-height: 1.5;
  word-wrap: break-word;
  max-width: 100%;
  white-space: pre-wrap; /* 改行を反映 */
}
/* ★追加：太字を強調するスタイル */
.bubble b, .bubble strong {
  font-weight: 700;
  color: #000; /* 太字部分を少し濃く */
}

.msg-bot { align-self: flex-start; flex-direction: row; }
.msg-bot .avatar { background-color: #6d84b4; margin-right: 10px; padding-bottom: 0; }
.msg-bot .bubble { background: #e4e6eb; color: #050505; border-top-left-radius: 5px; }

.msg-user { align-self: flex-end; flex-direction: row-reverse; }
.msg-user .avatar { background-color: #0084ff; margin-left: 10px; width: 44px; height: 44px; border: 2px solid #ffffff; box-sizing: border-box; padding-bottom: 4px; }
.msg-user .bubble { background: #0084ff; color: white; border-top-right-radius: 5px; }

/* ---------------------------------- */
/* 4. サジェストエリア (メニュー) */
/* ---------------------------------- */
.suggestion-area {
  padding: 12px;
  display: none; 
  flex-wrap: wrap;
  justify-content: center;
  border-top: 1px solid #ddd;
  background: #f9f9f9;
  animation: slideIn 0.2s ease-out;
}
@keyframes slideIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.chip {
  background: #ffffff;
  color: #050505;
  border: 1px solid #ccc;
  border-radius: 18px;
  padding: 8px 16px;
  margin: 4px;
  font-size: 0.9rem;
  cursor: pointer;
}
.chip:hover { background: #e4e6eb; }

/* ---------------------------------- */
/* 5. 入力エリア */
/* ---------------------------------- */
.input-area {
  padding: 12px;
  background: #f9f9f9;
  flex-shrink: 0;
  display: flex;
  align-items: center; 
}
#menuBtn {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: none;
  background: #e4e6eb;
  color: #555;
  font-size: 1.5rem;
  line-height: 1;
  cursor: pointer;
  margin-right: 10px;
  display: flex;
  justify-content: center;
  align-items: center;
  transition: transform 0.2s;
}
#menuBtn:hover { background: #d8dbe0; }
#menuBtn.open { transform: rotate(45deg); background: #555; color: white; }

#input {
  flex-grow: 1;
  padding: 10px 14px;
  font-size: 16px;
  border: 1px solid #ccc;
  border-radius: 20px;
  margin-right: 8px;
  background: #fff;
}
#send {
  padding: 10px 16px;
  font-size: 16px;
  background: #0084ff;
  color: white;
  border: none;
  border-radius: 20px;
  cursor: pointer;
  font-weight: bold;
  white-space: nowrap;
}
#send:hover { background: #0073e0; }
</style>
</head>
<body>

  <div class="container">
    <div class="header">
      <h2>スマートICTソリューション研究室 教授チャット</h2>
      <div class="header-controls">
        <label class="tts-label">
          <input type="checkbox" id="ttsSwitch"> 🗣️読み上げ
        </label>
        <button id="resetButton">リセット</button>
      </div>
    </div>

    <div id="chat"></div>

    <div class="suggestion-area" id="suggestionArea"></div>

    <div class="input-area">
      <button id="menuBtn">＋</button>
      <input id="input" type="text" placeholder="質問を入力..." />
      <button id="send">送信</button>
    </div>
  </div>

  <script>
    const chat = document.getElementById("chat");
    const input = document.getElementById("input");
    const send = document.getElementById("send");
    const resetButton = document.getElementById("resetButton");
    const ttsSwitch = document.getElementById("ttsSwitch");
    const menuBtn = document.getElementById("menuBtn");
    const suggestionArea = document.getElementById("suggestionArea");

    const PROFESSOR_IMAGE = "akiyama.jpg"; 

    // デフォルトの候補
    const defaultChips = ["研究室の場所は？", "研究テーマを教えて", "見学は可能？"];

    // ★追加：テキスト整形用の関数★
    function formatText(text) {
      if (!text) return "";
      // "**文字**" を "<b>文字</b>" に変換する
      return text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
    }

    function renderSuggestions(chipTexts) {
      suggestionArea.innerHTML = "";
      if (!chipTexts || chipTexts.length === 0) {
        suggestionArea.style.display = "none";
        menuBtn.classList.remove("open");
        return;
      }
      
      chipTexts.forEach(text => {
        if (!text.trim()) return;
        const btn = document.createElement("button");
        btn.className = "chip";
        btn.textContent = text.trim();
        btn.onclick = () => sendMessage(text.trim());
        suggestionArea.appendChild(btn);
      });
      
      suggestionArea.style.display = "flex";
      menuBtn.classList.add("open");
    }

    function speak(text) {
      if (!ttsSwitch.checked) return;
      // 読み上げ時は ** などの記号を消してから読むときれいです
      const cleanText = text.replace(/\*\*/g, ""); 
      window.speechSynthesis.cancel();
      const uttr = new SpeechSynthesisUtterance(cleanText);
      uttr.lang = "ja-JP";
      window.speechSynthesis.speak(uttr);
    }

    function append(msg, who = "bot") {
      const row = document.createElement("div");
      row.className = "msg-row " + (who === "user" ? "msg-user" : "msg-bot");
      const avatar = document.createElement("div");
      avatar.className = "avatar";
      if (who === "user") {
        avatar.innerText = "A";
      } else {
        const img = document.createElement("img");
        img.src = PROFESSOR_IMAGE;
        img.alt = "K";
        img.onerror = function() {
          this.style.display = 'none';
          avatar.innerText = "K";
          avatar.style.paddingBottom = "4px"; 
        };
        avatar.appendChild(img);
      }
      const bubble = document.createElement("div");
      bubble.className = "bubble";
      
      // ★変更点：ここで formatText を使って整形表示★
      bubble.innerHTML = formatText(msg);
      
      row.appendChild(avatar);
      row.appendChild(bubble);
      chat.appendChild(row);
      chat.scrollTop = chat.scrollHeight;
      return row;
    }

    async function sendMessage(presetMessage = null) {
      const text = presetMessage ? presetMessage : input.value.trim();
      if (!text) return;

      window.speechSynthesis.cancel();
      append(text, "user");
      
      if (!presetMessage) input.value = "";
      
      // 送信時はメニューを閉じる
      suggestionArea.style.display = "none";
      menuBtn.classList.remove("open");

      const loadingRow = append("（考え中...）", "bot");

      try {
        const res = await fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: text })
        });
        const data = await res.json();

        if (loadingRow && loadingRow.parentNode) {
          chat.removeChild(loadingRow);
        }

        if (data.answer) {
          // --- AIの回答処理 ---
          const parts = data.answer.split("---");
          const mainAnswer = parts[0].trim(); // 吹き出しに表示するメインの答え
          
          append(mainAnswer, "bot");
          speak(mainAnswer);
          
          // サジェスト部分があればボタンにする
          if (parts.length > 1) {
            const suggestions = parts[1].trim().split("\n");
            renderSuggestions(suggestions);
          }
        } else {
          append("すみません、返答が取得できませんでした。", "bot");
        }
      } catch (err) {
        if (loadingRow && loadingRow.parentNode) {
          chat.removeChild(loadingRow);
        }
        append("エラー: " + err, "bot");
      }
    }
    
    function resetChat() {
      window.speechSynthesis.cancel();
      chat.innerHTML = "";
      const msg = "こんにちは！スマートICTソリューション研究室の教授です。何か質問はありますか？";
      append(msg, "bot");
      speak(msg);
      renderSuggestions(defaultChips);
    }

    menuBtn.onclick = () => {
      if (suggestionArea.style.display === "flex") {
        suggestionArea.style.display = "none";
        menuBtn.classList.remove("open");
      } else {
        suggestionArea.style.display = "flex";
        menuBtn.classList.add("open");
      }
    };

    send.onclick = () => sendMessage(null);
    input.addEventListener("keydown", e => { if (e.key === "Enter") sendMessage(null); });
    resetButton.onclick = resetChat;
    
    window.onload = () => {
      resetChat();
    };
  </script>
</body>
</html>